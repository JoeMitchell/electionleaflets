{% extends "base.html" %}

{% block extra_head %}
<script src="{{ MEDIA_URL }}scripts/jquery.Jcrop.js" type="text/javascript"></script>
<script src="{{ MEDIA_URL }}scripts/json-min.js" type="text/javascript"></script>
<link rel="stylesheet" media="all" type="text/css" href="{{MEDIA_URL}}css/jquery.Jcrop.min.css" />
<style>
#annotspanel li { cursor: pointer; }
#annotspanel li.added { background-color: #fff8f8; }
#annotspanel li:hover { background-color: #fee; }
#annotspanel li.selected { background-color: #fbb; }
textarea#annotdesc:focus { background:pink; }
div#formpanel { display: none; position:fixed; left:0px; top:0px; width:400px; height: 600px; overflow: auto; border: thin blue solid; background: #e3e3ff; z-index:800 }
</style>

<script type="text/javascript">
var jcrop_api; 
var annotboxlist = [ ]; 
var annotboxselectedindex = -1; 

function selectannot(annotboxindex) {
    $("#annotspanel li").removeClass("selected"); 
    var annotbox = annotboxlist[annotboxindex]; 
    var asel = $("#"+annotbox.annotboxid);  //asel.get(0).scrollIntoView();
    var atop = asel.offset().top - 20; 
    var aheight = 20 + asel.height() + 200; 
    if (atop) {
        if(atop < $(window).scrollTop()) {
            $('html,body').animate({scrollTop:atop}, 200);
        } else if (atop + aheight > $(window).scrollTop() + (window.innerHeight || document.documentElement.clientHeight)) {
            $('html,body').animate({scrollTop:atop - (window.innerHeight || document.documentElement.clientHeight) + aheight + 15}, 200);
        } 
    }
    jcrop_api.animateTo(boxposbox(annotbox, jcrop_api.getBounds())); 
    $("#annotspanel li#"+annotbox.annottextid).addClass("selected"); 
    annotboxselectedindex = annotboxindex; 
    $("textarea#annotdesc").val(annotbox.description); 
    $("#opselect").val(annotbox.optype); 
    $("#annotdesc").focus(); 
}

function removeselection() { 
    $("#annotspanel li").removeClass("added"); 
    $("#annotspanel li").removeClass("selected"); 
    $("textarea#annotdesc").val(""); 
    annotboxselectedindex = -1; 
}; 

function focussavebox(optype) {
    removeselection(); 
    $("#opselect").val(optype); 
    $("#annotdesc").focus(); 
}

function boxposbox(annotbox, bounds) {
    return [ parseInt(annotbox.px*bounds[0]/1000), parseInt(annotbox.py*bounds[1]/1000), 
             parseInt(annotbox.px2*bounds[0]/1000), parseInt(annotbox.py2*bounds[1]/1000) ]; 
}

function boxposstyle(annotbox, bounds) {
    var bp = boxposbox(annotbox, bounds); 
    return 'left:'+bp[0]+'px;top:'+bp[1]+'px;width:'+(bp[2]-bp[0])+'px;height:'+(bp[3]-bp[1])+'px'; 
}

function commitbox(annotbox, sb) {
    var annotboxindex = annotboxlist.length; // into annotboxlist
    var annotboxid = 'annotbox_'+annotboxindex; 
    var annottextid = 'annottext_'+annotboxindex;
    annotbox.annotboxindex = annotboxindex; 
    annotbox.annotboxid = annotboxid; 
    annotbox.annottextid = annottextid;
    $("#annots1").append('<div id="'+annotboxid+'" style="'+boxposstyle(annotbox, sb)+'; position:absolute; border: thin red solid; display:inline-block; z-index:700; cursor: pointer; background-color: rgba(0, 0, 255, .1)"></div>'); 
    var annottext  = annotbox.optype+' p'+annotbox.page+':'+encodeURIComponent(annotbox.description).substr(0, 20).replace(/%20/g, " "); 
    $("#annotspanel ul").append('<li id="'+annottextid+'">'+annottext+'</li>'); 
    $("#"+annotboxid).click(function() { selectannot(annotboxindex); }); 
    $("#"+annottextid).click(function() { selectannot(annotboxindex); }); 
    annotboxlist.push(annotbox); 
}

function savebox() {
    var annotbox; 
    if (annotboxselectedindex == -1) { 
        var s = jcrop_api.tellSelect(); 
        if ((s.w == 0) || (s.h == 0))
            return; 
        var sb = jcrop_api.getBounds(); 
        annotbox = { px:parseInt(s.x*1000/sb[0]), px2:parseInt(s.x2*1000/sb[0]), py:parseInt(s.y*1000/sb[1]), py2:parseInt(s.y2*1000/sb[1]), page:1 }; 
        annotbox.description = $("textarea#annotdesc").val(); 
        annotbox.optype = $("#opselect").val(); 
        commitbox(annotbox, sb); 
    } else {
        annotbox = annotboxlist[annotboxselectedindex]; 
        annotbox.description = $("textarea#annotdesc").val(); 
        annotbox.optype = $("#opselect").val(); 
        var annottext  = annotbox.optype+' p'+annotbox.page+':'+encodeURIComponent(annotbox.description).substr(0, 20).replace(/%20/g, " "); 
        $("#"+annotbox.annottextid).text(annottext); 
    }

    jcrop_api.release(); 
    jcrop_api.focus(); 
    
    $("div#formpanel #id_description").val($.toJSON(annotboxlist)); 
    $("#annotspanel li#"+annotbox.annottextid).addClass("added"); 
}

function deletebox() {
    if (annotboxselectedindex != -1) {
        var ls = annotboxlist[annotboxselectedindex]; 
        ls.bdeleted = true; 
        $("#"+ls.annotboxid).remove(); 
        $("#"+ls.annottextid).remove(); 
    }
    jcrop_api.release(); 
}

function populateannots() {
    var jdesctext = $("div#formpanel #id_description").val().trim(); 
    var lannotboxlist = [ ]; 
    try {
        lannotboxlist = $.evalJSON(jdesctext); 
    } catch(err) {
        if (jdesctext.length > 0) {
            lannotboxlist.push({ "optype":"Content", "page":1, "px":100, "px2":900, "py":100, "py2":200, "description":jdesctext }); 
        }
    }
    for (var i = 0; i < lannotboxlist.length; i++)
        commitbox(lannotboxlist[i], jcrop_api.getBounds()); 
}

$(document).ready(function(){
    $('#leafpage1').Jcrop({
            bgColor:'black', 
            bgOpacity: 0.8,
            onSelect: removeselection, 
            onRelease: removeselection, 
            keySupport: true, 
            onKeypress: function(e) { 
                if (e.keyCode == 46)  deletebox(); 
                if (e.keyCode == 80)  focussavebox("Party");     // p
                if (e.keyCode == 67)  focussavebox("Candidate"); // c
                if (e.keyCode == 69)  focussavebox("Election");  // e
                if (e.keyCode == 68)  focussavebox("District");  // d
                if (e.keyCode == 73)  focussavebox("Imprint");   // i
                if (e.keyCode == 13)  focussavebox("Content");   // <return>
            }
        }, function() {
            jcrop_api = this;
            jcrop_api.setClass("jcropholder1");   // set a class name on the cropper system so we can find it
            
            // make the annotation holder with the non-selected boxes
            var compeleximgstyle = $($(".jcropholder1 img")[1]).attr("style"); 
            $(".jcropholder1").append('<div id="annots1" style="'+compeleximgstyle+'"></div>'); 
            
            populateannots();  // call this when all pages are ready
        }
    ); 
        
    
    $("#opsave").click(function() { savebox();  }); 
    $("#opdelete").click(deletebox); 
    $("div#annotspanel").keydown(function(e){
        if(e.ctrlKey && e.which === 83) {
            $("#opsave").click(); 
            e.preventDefault();
            return false;
        }
    });
    
    $("#opflip").click(function() { 
        $("#formpanel").hide(); 
        if ($("#annotspanel").css("right") == "0px")
            $("#annotspanel").css("right", "auto").css("left", "0px"); 
        else
            $("#annotspanel").css("left", "auto").css("right", "0px"); 
    }); 
    $("#opsubmit").click(function() { $("#formpanelsubmit").click(); }); 
    $("#opformtoggle").click(function() { 
        $("#formpanel").toggle(); 
        if ($("#annotspanel").css("left") == "0px")
            $("#annotspanel").css("left", "auto").css("right", "0px"); 
    }); 
}); 

</script>
{% endblock %}


{% block body %}
<div id="annotspanel" style="position:fixed; right:0px; top:0px; width:400px; height: 400px; border: thin blue solid; background: white; z-index:800">
    <div class="opclasses">
        <input type="button" id="opflip" value="Flip"/>
        <input type="button" id="opsubmit" value="Submit"/>
        <input type="button" id="opformtoggle" value="Formviz"/>
    </div>
    <ul style="height:190px; overflow: auto">
    </ul>
    <div style="height:180px">
        <span>Type:</span>
        <select id="opselect">
            <option>Party</option>
            <option>Candidate</option>
            <option>Election</option>
            <option>District</option>
            <option>Imprint</option>
            <option>Content</option>
            <option>Tweet</option>
            <option>Hidden</option>
        </select>
        <input type="button" id="opsave" value="Save"/>
        <input type="button" id="opdelete" style="font-weight: bold; font-style: italic" value="Delete"/>
        <a class='staff_link' href='/admin/leaflets/leaflet/{{ leaflet.id }}/'>Admin</a>
        <textarea id="annotdesc" style="width:390px; height:160px"></textarea>
    </div>
</div>

<div id="formpanel">
    <form id="leafletform" method="post" action=".">
        <fieldset>
                <ul>
                    <li>Title: {{ form.title }}  {{ form.title.errors }}</li>
                    <li>Description: {{ form.description }}</li>
                    <li>Postcode: {{ form.postcode }}  {{ form.postcode.errors }}</li>
                    <li>lat: {{ form.lat }}  {{ form.lat.errors }}</li>
                    <li>lng: {{ form.lng }}  {{ form.lng.errors }}</li>
                    <li>Date delivered: {{ form.date_delivered_text }}</li>
                    <li>Party: {{ form.publisher_party }}  {{ form.publisher_party.errors }}</li>
                    <li>Imprint: {{ form.imprint }}</li>
                    <li>Tags: {{form.tags }}</li>
                    <li>Name: {{ form.name }} {{ form.name.errors }}</li>
                    <li>Email: {{ form.email }} {{ form.email.errors }}</li>
                </ul>
        </fieldset>
        <div class="buttons">
            <input id="formpanelsubmit" type="submit" value="Save leaflet"/>
        </div>
    </form>
</div>

<div id="divContent">
    <div id="divFullImage" class="contentfull">
        <a href="{% url 'leaflet' leaflet.id%}">&larr; back to details of <em>{{ leaflet.title }}</em></a>
        <ul>
          {% for image in images %}
            <li id="{{ image.image_key }}"><img id="leafpage{{forloop.counter}}" class="theimg" src="{{ image.get_large }}" />
            <br/><hr/>
            </li>
          {% endfor %}
        </ul>
        <a href="{% url 'leaflet' leaflet.id%}">&larr; back to details of <em>{{ leaflet.title }}</em></a>
    </div>

</div>
{% endblock %}
